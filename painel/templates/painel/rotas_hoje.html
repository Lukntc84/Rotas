{% extends 'painel/base.html' %}

{% block title %}
  Rotas de hoje
{% endblock %}
{% block header_title %}
  Painel de Rotas
{% endblock %}
{% block header_sub %}
  Hoje: {{ hoje }}
{% endblock %}

{% block header_actions %}
  {% if perms.rotas.add_rota %}
    <a class="btn btn-primary" href="{% url 'painel:criar_rota' %}">+ Nova rota</a>
  {% endif %}
  <a class="btn" href="{% url 'painel:home' %}">InÃ­cio</a>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-title">
      <h2>Rotas de hoje</h2>
      <span class="badge">{{ rotas|length }} rota(s)</span>
    </div>

    <ul class="list">
      {% for r in rotas %}
        <li class="list-item">
          <div>
            <a class="title-link" href="{% url 'painel:rota_detalhe' r.id %}">{{ r.nome|default:'Rota sem nome' }} #{{ r.id }}</a>
            <div class="small muted">Motoboy: {{ r.motoboy.username }}</div>

<div class="small" style="margin-top: 5px;">
  {# 1. Primeiro, verifica se existem TransferÃªncias vinculadas #}
  {% if r.transferencias.all %}
    {% for t in r.transferencias.all %}
      <strong style="color: #3182ce;">{{ t.loja_origem.nome }} â†’ {{ t.loja_destino.nome }}</strong>
      {% if not forloop.last %} | {% endif %}
    {% endfor %}
  
  {# 2. Se nÃ£o houver transferÃªncias, verifica se existem Paradas (Lojas) #}
  {% elif r.paradas.all %}
    {% for p in r.paradas.all %}
      <span style="color: #4a5568;">{{ p.loja.nome }}</span>
      {% if not forloop.last %} â€¢ {% endif %}
    {% endfor %}

  {# 3. SÃ³ exibe o erro se os DOIS estiverem vazios #}
  {% else %}
    <span class="muted" style="color: #ef4444;">(Sem paradas ou transferÃªncias vinculadas)</span>
  {% endif %}
</div>

<div class="actions" style="display: flex; gap: 8px; align-items: center;">
    {% if r.motoboy.username %}
        {# Link direto para o WhatsApp do motorista #}
        <a href="https://wa.me/{{ r.motoboy.perfil.telefone|default:'' }}?text=OlÃ¡%20{{ r.motoboy.username }},%20uma%20nova%20rota%20foi%20atribuÃ­da%20a%20vocÃª:%20Rota%20%23{{ r.id }}.%20Confira%20no%20painel!" 
           target="_blank" 
           class="btn" 
           style="background-color: #25D366; color: white; border: none; padding: 8px 12px; display: flex; align-items: center; gap: 5px; text-decoration: none; border-radius: 4px; font-size: 13px;">
           <span style="font-size: 16px;">ðŸ’¬</span> WhatsApp
        </a>
    {% endif %}
    
    <a class="btn btn-primary" href="{% url 'painel:rota_detalhe' r.id %}">Abrir</a>
</div>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endblock %}
