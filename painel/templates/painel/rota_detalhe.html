{% extends 'painel/base.html' %}

{% block title %}
  Rota {{ rota.id }}
{% endblock %}
{% block header_title %}
  Rota #{{ rota.id }}
{% endblock %}
{% block header_sub %}
  {{ rota.data|date:'d/m/Y' }}
{% endblock %}

{% block header_actions %}
  <a class="btn" href="{% url 'painel:rotas_hoje' %}">Voltar</a>
  {% if perms.rotas.add_parada %}
    <a class="btn btn-primary" href="{% url 'painel:adicionar_loja_rota' rota.id %}">+ Adicionar loja</a>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-title">
      <h2>Paradas da Rota</h2>
      <span class="badge" id="count-badge">{{ paradas|length }} loja(s)</span>
    </div>

    <ul class="list" id="paradas-list">
      {% for p in paradas %}
        <li class="list-item" data-id="{{ p.id }}" style="cursor: grab;">
          <div class="drag-handle" style="margin-right: 15px; color: #ccc;">↕</div>

          <div style="flex-grow: 1;">
            <div>
              <strong class="ordem-numero">{{ p.ordem }}</strong> - {{ p.loja.nome }}
            </div>
            <div class="small muted">{{ p.loja.endereco }}, {{ p.loja.numero }}</div>
            <div class="small">
              Status:
              <span class="badge {% if p.status == 'coletado' %}badge-success{% endif %}">{{ p.get_status_display }}</span>
            </div>
          </div>

          <div class="actions">
            {% if p.status != 'coletado' %}
              <form method="post" action="{% url 'painel:marcar_coletado' p.id %}">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">Marcar coletado</button>
              </form>
            {% else %}
              <span style="color: green; font-weight: bold;">✔ Coletado</span>
            {% endif %}
          </div>
        </li>
      {% empty %}
        <li class="list-item">
          <span class="muted">Nenhuma parada gerada para esta rota.</span>
        </li>
      {% endfor %}
    </ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    const el = document.getElementById('paradas-list')
    const rotaId = '{{ rota.id }}'
    
    function getCookie(name) {
      let cookieValue = null
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';')
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim()
          if (cookie.substring(0, name.length + 1) === name + '=') {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
            break
          }
        }
      }
      return cookieValue
    }
    
    if (el) {
new Sortable(el, {
    animation: 150,
    // handle: '.drag-handle',  <-- REMOVA OU COMENTE ESTA LINHA
    ghostClass: 'dragging',
    onEnd: async function() {
        const ids = [...el.querySelectorAll("li[data-id]")].map(li => li.dataset.id);
        
        const response = await fetch(`/painel/rotas/${rotaId}/reordenar/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ ids: ids })
        });

        const result = await response.json();
        if (response.ok && result.ok === true) {
            el.querySelectorAll(".ordem-numero").forEach((span, index) => {
                span.textContent = index + 1;
            });
        } else {
            alert("Erro: " + (result.error || "Não foi possível salvar a ordem."));
        }
    }
});
    }
  </script>
{% endblock %}
