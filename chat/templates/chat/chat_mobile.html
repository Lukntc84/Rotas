<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>{{ destinatario.username }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <style>
        /* Reset total para garantir que ocupamos a tela certa */
        html { height: 100%; overscroll-behavior: none; }
        body { 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; 
            background: #f1f7ff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Impede scroll no body, apenas na div interna */
        }

        /* Container Principal que ser√° redimensionado pelo JS */
        #mobile-wrapper {
            display: flex; 
            flex-direction: column;
            height: 100%; /* Fallback */
            width: 100%;
            position: absolute; /* Absolute funciona melhor com teclado que Fixed */
            top: 0; left: 0; bottom: 0; right: 0;
        }

        /* Header Fixo */
        .chat-header {
            flex: 0 0 auto; /* N√£o encolhe */
            padding: 10px 15px; 
            background: #fff; 
            border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 15px; 
            height: 60px;
        }
        .chat-header a { color: #007bff; text-decoration: none; font-size: 1.2rem; }

        /* √Årea de Mensagens (Scroll√°vel) */
        #chat-box {
            flex: 1 1 auto; /* Ocupa o espa√ßo restante */
            overflow-y: scroll; /* Scroll for√ßado */
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            background-color: #f1f7ff;
            -webkit-overflow-scrolling: touch; /* Suavidade no iOS */
        }

        /* √Årea de Input Fixa na base do wrapper */
        .input-container {
            flex: 0 0 auto; /* N√£o encolhe */
            background: #fff; 
            border-top: 1px solid #eee;
            padding: 8px; 
            width: 100%;
            /* Padding bottom seguro para iPhone X+ */
            padding-bottom: max(8px, env(safe-area-inset-bottom));
        }

        .input-row { display: flex; align-items: flex-end; gap: 8px; }

        textarea {
            flex: 1; 
            border: 1px solid #ddd; border-radius: 20px;
            padding: 10px 15px; 
            outline: none; 
            font-size: 16px !important; /* CRUCIAL: 16px evita zoom no iOS */
            max-height: 120px; 
            resize: none;
            background: #f9f9f9;
        }

        /* Seus estilos de bal√£o e √°udio mantidos */
        #indicador-anexo { display: none; padding: 5px 10px; font-size: 0.8rem; background: #eef6ff; justify-content: space-between; border-top: 1px solid #ddd; }
        .msg-bubble { max-width: 85%; padding: 10px 14px; border-radius: 15px; margin-bottom: 10px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;}
        .msg-mine { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .msg-theirs { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; }
        .msg-horario { font-size: 0.6rem; opacity: 0.7; text-align: right; margin-top: 4px; display: block; }
        .waveform-container { display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.1); padding: 8px; border-radius: 10px; min-width: 180px; }
        .play-btn { background: #fff; color: #007bff; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .btn-action { border: none; background: none; color: #007bff; font-size: 1.4rem; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="mobile-wrapper">
    <div class="chat-header">
        <a href="{% url 'chat_lista' %}"><i class="fas fa-arrow-left"></i></a>
        <div style="display:flex; flex-direction:column; line-height: 1.2;">
            <strong>{{ destinatario.username }}</strong>
            <small style="font-size: 0.75rem; color: #28a745;">Online</small>
        </div>
    </div>

    <div id="chat-box"></div>

    <div id="status-gravacao" style="display:none; text-align: center; background: #fff1f1; padding: 5px; color: red;">
        <span>‚óè Gravando: </span> <span id="timer-gravacao">00:00</span>
    </div>
    <div id="indicador-anexo">
        <span id="nome-arquivo" style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap; max-width: 80%;"></span>
        <i class="fas fa-times" onclick="removerAnexo()" style="color:red; padding:5px;"></i>
    </div>

    <div class="input-container">
        <div class="input-row">
            <label for="file-input" class="btn-action"><i class="fas fa-paperclip"></i></label>
            <input type="file" id="file-input" style="display: none;">
            
            <textarea id="chat-input" rows="1" placeholder="Mensagem..."></textarea>
            
            <button id="btn-mic" class="btn-action" style="color: #666;"><i class="fas fa-microphone"></i></button>
            <button onclick="enviar()" class="btn-action"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DE REDIMENSIONAMENTO DO TECLADO ---
    // Esta √© a parte que faz a m√°gica no iOS e Android
    const wrapper = document.getElementById('mobile-wrapper');
    const chatBox = document.getElementById('chat-box');
    const inputArea = document.getElementById('chat-input');

    function resizeVisualViewport() {
        if (!window.visualViewport) return;
        
        // Define a altura do wrapper para ser EXATAMENTE a altura vis√≠vel (sem teclado)
        wrapper.style.height = window.visualViewport.height + 'px';
        
        // Garante que o scroll v√° para o fundo quando redimensionar
        setTimeout(() => {
            chatBox.scrollTop = chatBox.scrollHeight;
        }, 100);
    }

    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', resizeVisualViewport);
        window.visualViewport.addEventListener('scroll', resizeVisualViewport);
    }

    // Workaround extra para garantir que o input fique vis√≠vel ao focar
    inputArea.addEventListener('focus', () => {
        setTimeout(() => {
            window.scrollTo(0, 0); // Reseta scroll da janela
            chatBox.scrollTop = chatBox.scrollHeight; // Rola o chat
        }, 300);
    });

    // --- C√ìDIGO DO CHAT (MANTIDO) ---
    const destinatarioAtivo = "{{ destinatario.id }}";
    const MEU_ID = "{{ request.user.id }}";
    let wavesurfers = {};
    let mediaRecorder;
    let audioChunks = [];

    const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(`${wsProtocol}${window.location.host}/ws/chat/${MEU_ID}/`);

    chatSocket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (String(data.remetente_id) === String(destinatarioAtivo) || String(data.remetente_id) === String(MEU_ID)) {
            adicionarMensagemNaTela(data);
            if (String(data.remetente_id) === String(destinatarioAtivo)) fetch(`/chat/marcar-lida/${destinatarioAtivo}/`);
        }
    };

    fetch(`/chat/buscar/${destinatarioAtivo}/`).then(res => res.json()).then(data => {
        data.forEach(m => adicionarMensagemNaTela(m));
        // Pequeno delay para garantir rolagem ap√≥s carregamento de imagens
        setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 200);
    });

    function adicionarMensagemNaTela(m) {
        if (document.getElementById(`msg-${m.id}`)) return;
        const souEu = String(m.remetente_id) === String(MEU_ID);
        const div = document.createElement('div');
        div.id = `msg-${m.id}`;
        div.className = `msg-bubble ${souEu ? 'msg-mine' : 'msg-theirs'}`;

        let contentHtml = `<div style="white-space: pre-wrap;">${m.conteudo}</div>`; // pre-wrap mant√©m quebra de linha
        
        if (m.arquivo_url) {
            if (/\.(webm|wav|mp3|ogg|m4a|mp4)$/i.test(m.arquivo_url)) {
                contentHtml += `<div class="waveform-container"><button class="play-btn" onclick="toggleAudio(${m.id})"><i class="fas fa-play" id="icon-${m.id}"></i></button><div id="wave-${m.id}" style="flex: 1;"></div></div>`;
            } else if (/\.(jpeg|jpg|gif|png|webp)$/i.test(m.arquivo_url)) {
                contentHtml += `<img src="${m.arquivo_url}" style="max-width:100%; border-radius:10px; margin-top:5px; display:block;" onclick="window.open('${m.arquivo_url}')">`;
            }
        }
        
        // Formata hora
        let hora = '';
        if(m.horario) hora = m.horario;
        else if(m.timestamp) hora = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        div.innerHTML = `${contentHtml}<span class="msg-horario">${hora}</span>`;
        
        chatBox.appendChild(div);
        
        // Rolagem inteligente
        const isNearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 150;
        if (isNearBottom || souEu) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        if (m.arquivo_url && /\.(webm|wav|mp3|ogg|m4a|mp4)$/i.test(m.arquivo_url)) {
            setTimeout(() => {
                wavesurfers[m.id] = WaveSurfer.create({
                    container: `#wave-${m.id}`,
                    waveColor: souEu ? '#cce5ff' : '#999',
                    progressColor: souEu ? '#fff' : '#007bff',
                    height: 25, barWidth: 2, cursorWidth: 0
                });
                wavesurfers[m.id].load(m.arquivo_url);
                wavesurfers[m.id].on('finish', () => { document.getElementById(`icon-${m.id}`).className = 'fas fa-play'; });
            }, 100);
        }
    }

    function toggleAudio(id) { 
        if(wavesurfers[id]) {
            wavesurfers[id].playPause();
            const icon = document.getElementById(`icon-${id}`);
            icon.className = wavesurfers[id].isPlaying() ? 'fas fa-pause' : 'fas fa-play';
        }
    }

    function enviar() {
        const input = document.getElementById('chat-input');
        const file = document.getElementById('file-input');
        if (!input.value.trim() && !file.files[0]) return;

        const fd = new FormData();
        fd.append('destinatario_id', destinatarioAtivo);
        fd.append('conteudo', input.value);
        fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        if (file.files[0]) fd.append('arquivo', file.files[0]);

        // Limpa UI imediatamente para sensa√ß√£o de velocidade
        const textoTemp = input.value;
        input.value = ''; 
        file.value = '';
        document.getElementById('indicador-anexo').style.display = 'none';
        input.focus(); // Mant√©m teclado aberto

        fetch('/chat/enviar/', { method: 'POST', body: fd });
    }

    // --- ANEXOS E √ÅUDIO ---
    document.getElementById('file-input').addEventListener('change', function() {
        if (this.files[0]) {
            document.getElementById('nome-arquivo').innerText = this.files[0].name;
            document.getElementById('indicador-anexo').style.display = 'flex';
        }
    });
    function removerAnexo() { document.getElementById('file-input').value = ""; document.getElementById('indicador-anexo').style.display = 'none'; }

    // Grava√ß√£o
    document.getElementById('btn-mic').onclick = async function() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.start();
                document.getElementById('status-gravacao').style.display = 'block';
                this.style.color = 'red';
                
                let secs = 0;
                const timer = setInterval(() => {
                    secs++;
                    document.getElementById('timer-gravacao').innerText = new Date(secs * 1000).toISOString().substr(14, 5);
                    if (!mediaRecorder || mediaRecorder.state === 'inactive') clearInterval(timer);
                }, 1000);

                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const fd = new FormData();
                    fd.append('destinatario_id', destinatarioAtivo);
                    fd.append('conteudo', 'üé§ √Åudio');
                    fd.append('arquivo', new File([blob], 'audio.webm'));
                    fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    fetch('/chat/enviar/', { method: 'POST', body: fd });
                    stream.getTracks().forEach(t => t.stop());
                    document.getElementById('status-gravacao').style.display = 'none';
                    this.style.color = '#666';
                };
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            } catch (e) { alert('Erro microfone'); }
        } else {
            mediaRecorder.stop();
        }
    };
</script>
</body>
</html>